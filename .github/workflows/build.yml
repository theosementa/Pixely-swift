name: Quality Phase

on:
  push:
    branches:
      - main
      - develop

jobs:
  build:
    name: Build & Analysis
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          
      - uses: swift-actions/setup-swift@65540b95f51493d65f5e59e97dcef9629ddf11bf
        with:
          swift-version: "6.1.0"

      - uses: actions/setup-python@v5.3.0
        with:
          python-version: '3.12'

      # Configuration Git GLOBALE pour tous les outils
      - name: Configure git authentication globally
        run: git config --global url."https://${GH_TOKEN}@github.com/theosementa/".insteadOf "https://github.com/theosementa/"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      # Résolution des dépendances
      - name: Resolve Swift Package dependencies
        run: xcodebuild -resolvePackageDependencies
        timeout-minutes: 8
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          
      - name: Build Pixely
        run: swift build
          
      # SwiftLint sur tout le projet
      - name: Install and Run SwiftLint
        run: | 
          brew install swiftlint
          swiftlint lint --quiet --reporter json > sonarqube-swiftlint.json
        continue-on-error: true
        
      # Mobsfscan
      - name: mobsfscan
        uses: MobSF/mobsfscan@main
        with:
            args: '. --sarif -o mobsfscan-report.sarif'
          
      # Exécution des tests avec couverture
      - name: Run tests with coverage
        run: |
          xcodebuild test \
            -project Pixely.xcodeproj \
            -scheme Pixely \
            -testPlan PixelyTestPlan \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -enableCodeCoverage YES \
            -derivedDataPath DerivedData \
        timeout-minutes: 8
        continue-on-error: true

      # Conversion de la couverture au format SonarQube générique
      - name: Convert coverage to SonarQube format
        run: |
          # Trouver le fichier .xcresult
          XCRESULT_PATH=$(find DerivedData/Logs/Test -name "*.xcresult" | head -n 1)
          
          # Télécharger le script de conversion
          curl -o xccov-to-sonarqube.sh https://raw.githubusercontent.com/SonarSource/sonar-scanning-examples/master/swift-coverage/swift-coverage-example/xccov-to-sonarqube-generic.sh
          chmod +x xccov-to-sonarqube.sh
          
          # Convertir au format SonarQube
          ./xccov-to-sonarqube.sh "$XCRESULT_PATH" > sonarqube-coverage.xml

      # SonarQube
      - uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
