name: Quality Phase

on:
  push:
    branches:
      - main
      - develop

jobs:
  build:
    name: Build & Analysis
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5.3.0
        with:
          python-version: '3.12'

      # Configuration Git GLOBALE pour tous les outils
      - name: Configure git authentication globally
        run: git config --global url."https://${GH_TOKEN}@github.com/theosementa/".insteadOf "https://github.com/theosementa/"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      # Résolution des dépendances
      - name: Resolve Swift Package dependencies
        run: xcodebuild -resolvePackageDependencies -verbose
        timeout-minutes: 8
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          
          # Exécution des tests avec couverture
      - name: Run tests with coverage
        run: |
          xcodebuild test \
            -project Pixely.xcodeproj \
            -scheme Pixely \
            -testPlan PixelyTestPlan \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -enableCodeCoverage YES \
            -derivedDataPath DerivedData \
            | tee xcodebuild.log
        continue-on-error: true

      # Conversion de la couverture au format SonarQube générique
      - name: Convert coverage to SonarQube format
        run: |
          # Trouver le fichier .xcresult
          XCRESULT_PATH=$(find DerivedData/Logs/Test -name "*.xcresult" | head -n 1)
          echo "XCResult path: $XCRESULT_PATH"
          
          # Extraire la couverture en JSON
          xcrun xccov view --report --json "$XCRESULT_PATH" > coverage.json
          
          # Vérifier que le JSON est créé
          if [ ! -f "coverage.json" ] || [ ! -s "coverage.json" ]; then
            echo "Error: coverage.json not created or empty"
            cat coverage.json || echo "File does not exist"
            exit 1
          fi
          
          echo "Coverage JSON created successfully:"
          ls -lh coverage.json
          
          # Télécharger le script de conversion
          curl -o xccov-to-sonarqube.sh https://raw.githubusercontent.com/SonarSource/sonar-scanning-examples/master/swift-coverage/swift-coverage-example/xccov-to-sonarqube-generic.sh
          chmod +x xccov-to-sonarqube.sh
          
          # Convertir au format SonarQube
          ./xccov-to-sonarqube.sh coverage.json > sonarqube-coverage.xml
          
          # Vérifier le contenu
          echo "Coverage XML generated:"
          head -20 sonarqube-coverage.xml

      # SwiftLint sur tout le projet
      - name: Install and Run SwiftLint
        run: | 
          brew install swiftlint
          swiftlint lint --quiet --reporter json > sonarqube-swiftlint.json
        continue-on-error: true

      # Mobsfscan en SARIF
      - name: mobsfscan
        run: |
          pip install mobsfscan
          mobsfscan . --sarif > mobsfscan-report.sarif
          echo "Mobsfscan SARIF completed, checking output..."
          if [ -f "mobsfscan-report.sarif" ]; then
            echo "SARIF file created successfully"
            head -20 mobsfscan-report.sarif
          else
            echo "SARIF file not found!"
          fi

      # SonarQube
      - uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
